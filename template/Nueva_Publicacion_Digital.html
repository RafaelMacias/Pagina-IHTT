<link href="@@DIR@@css/sweetalert.css" type="text/css" rel="stylesheet" media="screen,projection"> 
<style>

/*the container must be positioned relative:*/
.autocomplete {
  position: relative;
  display: inline-block;
}
.autocomplete-items {
  position: absolute;
  border: 1px solid #d4d4d4;
  border-bottom: none;
  border-top: none;
  z-index: 99;
  /*position the autocomplete items to be the same width as the container:*/
  top: 100%;
  left: 36px;
  right: 0;
}

.autocomplete-items div {
  padding: 10px;
  cursor: pointer;
  background-color: #fff; 
  border-bottom: 1px solid #d4d4d4; 
}

/*when hovering an item:*/
.autocomplete-items div:hover {
  background-color: #e9e9e9; 
}

/*when navigating through the items using the arrow keys:*/
.autocomplete-active {
  background-color: DodgerBlue !important; 
  color: #ffffff; 
}
a:link {
  text-decoration: none;
}

a:visited {
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

a:active {
  text-decoration: underline;
}
.github-big-icon {
  position: absolute;
  right: 150px;
  top: 2px;
}
.github-big-icon span {
    font-size: 400px;
    opacity: .1;
}

.sweet-alert {
  border-radius: 20px;
  border-style: solid;
  border-color: #424aa07a !important;
  border-width: 5px
}

.m .sweet-overlay {
  background-color: rgba(0, 188, 212, 0.27);
}

.a .sweet-overlay {
  background-color: rgba(239, 67, 13, 0.45);
}
.ck.ck-content.ck-editor__editable.ck-rounded-corners.ck-editor__editable_inline.ck-blurred {
  height: 500px;
}
.ck.ck-editor__editable:not(.ck-editor__nested-editable).ck-focused {
  outline: none;
  border: var(--ck-focus-ring);
  box-shadow: var(--ck-inner-shadow),0 0;
  height: 500px;
}
.col-center {
  float: none;
  margin-left: auto;
  margin-right: auto;
}
label {
  color: #5bcfde;
}
</style>
<input class="form-control datepicker" id="valinput" type="hidden" value="1">
<div class="section section-lg" style="padding-top: 0rem;padding-bottom: 2rem;">
   <div class="container">
      <div class="row pt-5 pt-md-0">
         <!--contenido-->
         <div class="col-12 col-lg-12">

            <div class="row">

               <div class="col-12 col-sm-12 mb-4">
                  <div class="card text-center border-light" style="min-height: 25.2rem;">
                     <h2 class="h1 mb-3 text-center"><i class="far fa-edit" style="margin-right: 5px;font-size: 4rem;line-height: 2;"></i>Nueva Publicaci&oacute;n</h2>
                      <div class="card-header">
                        <!-- <span class="card-text small" style="font-size: 95%;">
                            <span class="fas fa-exclamation-circle mr-2" style="color: #424aa0; font-size: 20px;"></span>
                             Con la herramienta de publicación, puedes preparar cualquier documento para los medios.
                        </span> -->
                        <div class="github-big-icon"><span class="fas fa-edit"></span></div>
                      </div>
                      <div class="card-body">

                        <div class="row mb-3">

                          <div class="col-12 col-lg-6">
                            <div class="form-group text-left">
                               <label class="my-1 mr-2" for="tipopublicacion" style="margin-bottom: .50rem!important;">Tipo de publicaci&oacute;n *</label>
                               <select onchange="getDesc_TipoPublicacion();" class="custom-select my-1 mr-sm-2 select2bs4" id="tipopublicacion" style="width: 100%;">
                                  <option value="-1" disabled selected>Seleccione tipo de Publicaci&oacute;n</option>
                                  @@TIPO@@
                              </select>
                            </div>
                          </div>

                          <input id="desctipo" type="hidden" class="form-control" disabled="">

                        </div>

                        <hr>
                        <div class="row">

                          <div class="col-12 col-lg-12">
                            <div class="form-group text-left">
                              <label for="Nombre">Titular *</label>
                              <input type="text" class="form-control" id="nombreplu" placeholder="Ingrese el nombre del titular de la publicación">
                            </div>
                          </div>

                        </div>

                        <div class="row">

                          <div class="col-12 col-lg-6">
                            <div class="form-group text-left">
                               <label class="my-1 mr-2" for="catpublicacion" style="margin-bottom: .50rem!important;">Seleccionar categor&iacute;a de la publicaci&oacute;n *</label>
                               <select class="custom-select my-1 mr-sm-2 select2bs4" id="catpublicacion" style="width: 100%;">
                                  <option value="-1" disabled selected>Seleccione categor&iacute;a</option>
                                  @@CATEGORIASP@@
                              </select>
                            </div>
                          </div>

                          <div class="col-12 col-lg-6">
                              <div class="form-group text-left">
                                <label for="fechaplu" style="margin-bottom: .6rem;">Fecha publicaci&oacute;n *</label>
                                <div class="input-group mb-4">
                                    <div class="input-group-prepend"><span class="input-group-text"><span class="far fa-calendar-alt"></span></span>
                                    </div>
                                     <input class="form-control datepicker" id="fechaplu" placeholder="Seleccionar fecha" type="text" aria-label="Date with icon left">
                                </div>
                              </div>
                            </div>
                          
                        </div>
                        <hr>


                        <div id="tarjetaimagen">

                          <div class="row">

                            <div class="col-12 col-lg-12">
                              <div class="form-group text-left">
                                <label for="nombreimg">Nombre de la imagen *</label>
                                <input type="text" class="form-control" id="nombreimg" placeholder="Nombre de la imagen">
                              </div>
                            </div>
                            

                          </div>

                          <div class="row">

                            <div class="col-12 col-lg-6">
                              <div class="form-group text-left">
                                <label for="EscaneoSolicitud">Cargar imagen</label>
                                <div class="custom-file">
                                  <input onchange="CargaImgPublicacion();" type="file" class="custom-file-input" id="EscaneoSolicitud" aria-label="File upload"> 
                                  <label class="custom-file-label" for="EscaneoSolicitud">Seleccionar la imagen que desea utilizar</label>
                                  <input type="hidden" id="ArchivoTemporal" value="0">
                                </div>
                              </div>
                            </div>
                            
                            <input id="idimagen" type="hidden" class="form-control" disabled="">
                          </div>

                          <div class="row">
                            <div id="tarimagen" class="col-12 col-md-6 col-lg-6 col-center" style="display: none;">
                               <div class="card border-0 text-center">
                                  <div class="card-header border-0 bg-white"><img src="" class="card-img-top rounded shadow border-0" alt="James Portrait" id="preview"></div>
                                  <div class="card-body">
                                     <h3 class="h4 card-title" style="margin-top: -20px;"><div id="nombreimagen"></div></h3>
                                     <ul class="list-unstyled d-flex justify-content-center mt-3 mb-0">
                                        <li>
                                          <button onclick="getIdImagen();" class="btn btn-pill btn-danger" type="button">
                                            <span class="far fa-trash-alt"></span>
                                          </button>
                                        </li>
                                     </ul>
                                  </div>
                               </div>
                            </div>


                          </div>

                        </div><!--oculta tarjeta de datos imagen-->

                        
                        <p>&nbsp;</p>

                        <div class="row">
                          <div class="col-12 col-md-6 col-lg-12">
                            <button style="width: 100%" onclick="confirmar_Guarar();" class="btn mb-2 mr-2 btn-light animate-up-2" type="button">Guardar publicación</button>
                          </div>
                        </div>

                     </div>
                  </div>
               </div>

            </div>
            
         </div>
      </div>
   </div>
</div>


<script>
//Funcion para recuperar la descripcion del tipo de publicacion
function getDesc_TipoPublicacion() {

  postdata = {
      action: "get-desc-tipopublicacion",
      tipo: $("#tipopublicacion").val()
   }
   $.post( "Api_PW.php", postdata, null, "json" )
      .done(function( data, textStatus, jqXHR ) {
         //console.log(data);
         var tipo = data[0];
         if(data[1]>0){
            $("#desctipo").val(tipo[0].DESC_Tipo_Publicacion);
         } 
      })
   .fail(function( jqXHR, textStatus, errorThrown ) {
      if ( console && console.log ) {
         //toasterror("Error de conexión intenta nuevamente");
         swal({
            type: 'error',
            title: '!Error¡',
            text: 'Error funcion desc publicación',
         })
      }
   });
}


//Funcion para cargar archivos adjuntos
function CargaImgPublicacion(){
$('#numeracion').html('0%');
$('.determinate').css('width','0%')

    var validarsubir=$('.file-path').val();
    var documentoFTT = $('#EscaneoSolicitud').prop('files')[0];

    if(validarsubir==""){
      toastwarning("!ERROR¡ Debe Seleccionar un Archivo Primero");
      return false;
    }
    if($("#tipopublicacion").val()==null){
      toastwarning("Debe seleccinar el tipo de publicación");
      return;
    }
    if($("#nombreimg").val().trim().length<1){
      toastwarning("El Campo del Nombre esta Vacío");
      return;
    }

    var form_data = new FormData();
    form_data.append("action","save-img-publicacion-dig");
    form_data.append("desctipo",$('#desctipo').val());
    form_data.append("nombreimg",$('#nombreimg').val());
    form_data.append("tipopublicacion",$('#tipopublicacion').val());
    form_data.append("EscaneoSolicitud",documentoFTT);
    form_data.append("ArchivoTemporal",$('#ArchivoTemporal').val());

      sweetAlert({ 
          title: "Subiendo archivo(s)",
          text: '<div id="barra" > <div class="progress"> <div class="determinate" style="width: 0%"></div> </div> <div id="numeracion" style=" text-align: center; ">0%</div> </div>',
          html: true,
          showConfirmButton: false
      });
      $("#barra").show(400);

         $.ajax({
          url: 'Api_PW.php',
          dataType: 'json',
          cache: false,
          contentType: false,
          processData: false,
          data: form_data,
          type: 'post',
          success: function(data){
              var datar = data;
              console.log(datar);
              if(datar.result==1){

                  swal({title: "Archivo(s) Subidos",
                        text: "archivo subido con exito ...",
                        confirmButtonText: "Presione Ok Para Continuar"},
                      function(){
                      // ArchivosSolicitud(); 
                  });
                  $("#contenthome").removeClass("a");
                  $("#contenthome").addClass("m");

                  $('#ArchivoTemporal').val(datar.TBARCHIVO);
                  //Id de la imagen
                  $('#idimagen').val(datar.IDI);
                  //Nombre de la imagen
                  $("#nombreimagen").html(datar.Nombre);
                  //Limpia el input
                  $('.file-path').val('');
                  RecuperarImgPublicacion(datar.Nombre,datar.Tipo);
            }else if (datar.result==3) {
              sweetAlert("EL ARCHIVO NO SE PUDO SUBIR", "Ya existe un tipo de archivo con ese nombre", "error");
              $('.file-path').val('');
            }else if (datar.result==4) {
              sweetAlert("EL ARCHIVO NO SE PUDO SUBIR", "Debe de seleccionar un archivo", "error");
              $('.file-path').val('');
            }else if (datar.result==5) {
              sweetAlert("EL ARCHIVO NO SE PUDO SUBIR", "El tipo de archivo seleccionado no esta permitido para subir", "error");
              $('.file-path').val('');
            }else {
              sweetAlert("!ATENCIÓN¡",data, "error");
              $('.file-path').val('');
            }
          },
       xhr: function() {
        // creamos un objeto XMLHttpRequest
        var xhr = new XMLHttpRequest();
 
        // gestionamos el evento 'progress'
        xhr.upload.addEventListener('progress', function(evt) {
 
          if (evt.lengthComputable) {
            // calculamos el porcentaje completado de la carga de archivos
            var percentComplete = evt.loaded / evt.total;
            percentComplete = parseInt(percentComplete * 100);
 
            // actualizamos la barra de progreso con el nuevo porcentaje
            $('#numeracion').html(percentComplete+'%');
            $('.determinate').css('width',''+percentComplete+'%');

            // una vez que la carga llegue al 100%, ponemos la progress bar como Finalizado
            if (percentComplete === 100) {
              $('.progress-bar').html('Finalizado');
            }
          }
        }, false);
 
        return xhr;
      }
     })
}

function RecuperarImgPublicacion(nombre,tipo) {

  $("#tarimagen").show();

  var dataurl = 'Documentos/Imagenes/'+tipo+'/'+nombre;
  document.getElementById('preview').src = dataurl;
            
}

function getIdImagen() {

  confirmarEliminarImagen($('#idimagen').val());

}

//Funcion para eliminar la imagen cargada
function confirmarEliminarImagen(id){

  swal({ 
  title: "",
  text: '<div class="fm-notification-body"> <div class="fm-notification-icon"> <div class="fm-del-contact-avatar"> <span></span> <div class="fm-del-contacts-number">1</div> </div> </div> <div class="fm-notification-info"> <p>¿Estás seguro de que quieres eliminar la imagen seleccionada?</p> <div class="fm-notification-warning">Aviso: Cualquier imagen eliminada no se podra recuperar!</div> </div> <div class="clear"></div> </div>',
  html: true,
  showCancelButton: true,
  cancelButtonText: "No",
  confirmButtonColor: "#DD6B55",
  confirmButtonText: "Si",
  closeOnConfirm: false 
},function(){
  EliminarImagen(id);
});
   
$("#contenthome").removeClass("m");
$("#contenthome").addClass("a");
}

function EliminarImagen(id){
  sweetAlert({ title: "",
     text: "espere un momento por favor ...",
     showConfirmButton: false,
  }); 
   var form_data = new FormData();
   form_data.append("action","EliminarIma-publicaciondig");
   form_data.append("Borrar",id);
   form_data.append("nombre_imagen",$('#nombreimagen').html());
   form_data.append("desctipo",$('#desctipo').val());

   $.ajax({
    url: 'Api_PW.php',
    dataType: 'json',
    cache: false,
    contentType: false,
    processData: false,
    data: form_data,
    type: 'post',
        success: function(dataserver){
          swal("¡Borrada!", "La imagen a sido Eliminado", "success");
          LimpiarCamposImagen();
       }
    });
}

function LimpiarCamposImagen() {
  $("#tarimagen").hide();
  var no_image = 'assets/img/no-image.png';
  document.getElementById('preview').src = no_image;
  $('.file-path').val('');
  $('#nombreimg').val('');
  $('#nombreimagen').html('');
  $("#posimagen").val('-1').trigger('change');
}

//Funcion para confirmar guardar solicitud de constancia
function confirmar_Guarar(){
  //Datos de la constancia
  if($("#nombreplu").val().trim().length<1){
    toastwarning("Debe especificar el nombre de la publicación.");
    return;
  }
  if($("#fechaplu").val().trim().length<1){
    toastwarning("Debe seleccionar la fecha de publicación.");
    return;
  }
  if($("#catpublicacion").val()==null){
    toastwarning("Debe seleccinar una categoría");
    return;
  }
  
  swal({
      title: "¿Esta Seguro de Guardar los Cambios?",
      text: "¡Una vez generada la solicitud no podrá deshacer los cambios!",
      type: "warning",
      html:true,
      showCancelButton: true,
      cancelButtonText: "!No¡ cancelar",
      confirmButtonColor: "#DD6B55",
      confirmButtonText: "!Si¡ guardar",
      closeOnConfirm: false
    },
    function(){
      savePublicacion();
    });
   $("#contenthome").removeClass("m");
   $("#contenthome").addClass("a");
}

//Funcion de insert pasesalida
function savePublicacion() {

  var form_data = new FormData();
    form_data.append("action","save-publicacion");
    //Datos del pase de salida
    form_data.append("nombreplu", $("#nombreplu").val());
    form_data.append("fechaplu", $("#fechaplu").val());
    form_data.append("idimagen", $("#idimagen").val());
    form_data.append("catpublicacion", $("#catpublicacion").val());
    form_data.append("tipopublicacion", $("#tipopublicacion").val());
    form_data.append("tipoinsert", 1);

    
    fetch("Api_PW.php",
    {
      method: "POST",
      body: form_data
    })
      .then((resp) => resp.json())
      .then(Data=>{
        if (Data.status==1) {
          swal({
            title: "Publicación guardada satisfactoriamente!",
            text: "<b>Nota:</b> La Publicación estará publica en la fecha que haya elegido.",
            type: "success",
            html:true,
            confirmButtonText: "Continuar"
          },function () {
            window.open('https://www.transporte.gob.hn/Publicacion_Digital.php?ID='+Data.ID, '_blank');
            actualizar()
          });
          $("#contenthome").removeClass("a");
          $("#contenthome").addClass("m");
        } else {
          sweetAlert("!ATENCIÓN¡",Data.status, "error");
        }
      })
    .catch(err=>{ console.log(err); });
}

function actualizar(){
  window.location.reload(true);
}

</script>